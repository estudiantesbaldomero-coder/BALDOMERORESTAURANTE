<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Restaurante Escolar IE Baldomero Sanín Cano</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f8f9fa; }
    header { background: #2c3e50; color: #fff; padding: 1rem; text-align: center; font-size: 1.3rem; }
    main { padding: 1rem; }
    section { margin-bottom: 2rem; }
    h2 { border-bottom: 2px solid #ccc; padding-bottom: .3rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: .5rem; text-align: center; }
    th { background: #eee; }
    button { margin: .2rem; padding: .4rem .8rem; border: none; background: #3498db; color: #fff; cursor: pointer; border-radius: 4px; }
    button:hover { background: #2980b9; }
    #qrCodesContainer { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 1rem; }
    .qr-item { border: 1px solid #ccc; padding: .5rem; text-align: center; background: #fff; }
    canvas { max-width: 100%; }
    video { width: 100%; max-width: 400px; border: 2px solid #333; margin-top: 1rem; }
    #dashboard { display: flex; gap: 2rem; flex-wrap: wrap; }
    .card { background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,.1); flex: 1; min-width: 200px; }
    #scanResult { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <header>Restaurante Escolar IE Baldomero Sanín Cano</header>
  <main>
    <section>
      <h2>Cargar estudiantes (CSV)</h2>
      <input type="file" id="csvFile" accept=".csv">
    </section>

    <section>
      <h2>Gestión de Estudiantes</h2>
      <table>
        <thead>
          <tr><th>Nombre</th><th>Grado</th><th>QR</th><th>Acciones</th></tr>
        </thead>
        <tbody id="studentsTable"></tbody>
      </table>
    </section>

    <section>
      <h2>Códigos QR</h2>
      <button onclick="printQRCodes()">Imprimir QR</button>
      <div id="qrCodesContainer"></div>
    </section>

    <section>
      <h2>Escáner de QR</h2>
      <button id="startScanner">Iniciar escáner</button>
      <video id="video" autoplay></video>
      <canvas id="qrCanvas" hidden></canvas>
      <p id="scanResult"></p>
    </section>

    <section>
      <h2>Dashboard</h2>
      <div id="dashboard">
        <div class="card">
          <h3>Total estudiantes</h3>
          <p id="totalStudents">0</p>
        </div>
        <div class="card">
          <h3>Asistencias registradas</h3>
          <p id="totalAttendance">0</p>
        </div>
      </div>
    </section>
  </main>

  <!-- QR generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <!-- QR scanner -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>

  <script>
    let students = [];
    let attendance = new Set();

    // Cargar CSV
    document.getElementById('csvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const lines = e.target.result.split(/\r?\n/).filter(l => l.trim() !== "");
        students = lines.map((line, index) => {
          const [nombre, grado] = line.split(",");
          return { id: index+1, nombre: nombre.trim(), grado: grado.trim() };
        });
        renderStudents();
      };
      reader.readAsText(file);
    });

    // Renderizar estudiantes y QR
    function renderStudents() {
      const tbody = document.getElementById('studentsTable');
      tbody.innerHTML = "";
      const qrContainer = document.getElementById('qrCodesContainer');
      qrContainer.innerHTML = "";

      students.forEach(st => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td contenteditable="true">${st.nombre}</td>
          <td contenteditable="true">${st.grado}</td>
          <td><canvas id="qr-${st.id}"></canvas></td>
          <td><button onclick="deleteStudent(${st.id})">Eliminar</button></td>
        `;
        tbody.appendChild(tr);

        // Generar QR más grande
        const qr = new QRious({
          element: document.getElementById(`qr-${st.id}`),
          value: JSON.stringify(st),
          size: 200
        });

        // Para impresión
        const div = document.createElement('div');
        div.className = "qr-item";
        div.innerHTML = `<p>${st.nombre} - ${st.grado}</p><img src="${qr.toDataURL()}" />`;
        qrContainer.appendChild(div);
      });

      updateDashboard();
    }

    function deleteStudent(id) {
      students = students.filter(s => s.id !== id);
      renderStudents();
    }

    function printQRCodes() {
      const content = document.getElementById('qrCodesContainer').innerHTML;
      const w = window.open("", "", "width=800,height=600");
      w.document.write("<html><head><title>Imprimir QR</title></head><body>" + content + "</body></html>");
      w.document.close();
      w.print();
    }

    // Dashboard
    function updateDashboard() {
      document.getElementById('totalStudents').textContent = students.length;
      document.getElementById('totalAttendance').textContent = attendance.size;
    }

    // Escáner
    document.getElementById('startScanner').addEventListener('click', startScanner);

    function startScanner() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('qrCanvas');
      const ctx = canvas.getContext('2d');

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          video.srcObject = stream;
          video.setAttribute("playsinline", true);
          video.play();
          requestAnimationFrame(tick);
        })
        .catch(err => {
          alert("Error al iniciar cámara: " + err);
        });

      function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
          if (code) {
            ctx.beginPath();
            ctx.moveTo(code.location.topLeftCorner.x, code.location.topLeftCorner.y);
            ctx.lineTo(code.location.topRightCorner.x, code.location.topRightCorner.y);
            ctx.lineTo(code.location.bottomRightCorner.x, code.location.bottomRightCorner.y);
            ctx.lineTo(code.location.bottomLeftCorner.x, code.location.bottomLeftCorner.y);
            ctx.closePath();
            ctx.lineWidth = 4;
            ctx.strokeStyle = "green";
            ctx.stroke();

            document.getElementById('scanResult').textContent = "Estudiante detectado: " + code.data;
            if (!attendance.has(code.data)) {
              attendance.add(code.data);
              updateDashboard();
              // Voz
              const msg = new SpeechSynthesisUtterance("Estudiante registrado");
              window.speechSynthesis.speak(msg);
            }
          }
        }
        requestAnimationFrame(tick);
      }
    }
  </script>
</body>
</html>
